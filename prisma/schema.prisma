generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(cuid())
  email            String           @unique
  name             String?
  phone            String?
  company          String?
  password         String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  resetToken       String?
  resetTokenExpiry DateTime?
  advancePayments  AdvancePayment[]
  customers        Customer[]
  Expense          Expense[]
  payments         Payment[]
  sales            Sale[]
}

model Customer {
  id               String           @id @default(cuid())
  name             String
  phone            String?
  email            String?
  address          String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  userId           String
  dueAmount        Float            @default(0)
  lastPurchaseDate DateTime?
  advanceBalance   Float            @default(0)
  advancePayments  AdvancePayment[]
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments         Payment[]
  sales            Sale[]

  @@index([userId])
}

model Sale {
  id                String           @id @default(cuid())
  invoiceNo         String           @unique
  customerId        String
  userId            String
  items             Json
  totalAmount       Float
  paidAmount        Float            @default(0)
  dueAmount         Float
  paymentType       String
  status            String           @default("pending")
  dueDate           DateTime?
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  bankTransactionId String?
  deliveryAddress   Json?
  deliveryDate      DateTime?
  deliveryNotes     String?
  deliveryStatus    String?          @default("pending")
  discountAmount    Float?           @default(0)
  discountType      String?
  discountValue     Float?           @default(0)
  isBackDate        Boolean?         @default(false)
  paymentMode       String?          @default("cash")
  paymentReference  String?
  saleDate          DateTime?        @default(now())
  advancePayments   AdvancePayment[]
  payments          Payment[]
  customer          Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([customerId])
  @@index([deliveryStatus])
}

model Payment {
  id              String   @id @default(cuid())
  saleId          String
  amount          Float
  method          String
  notes           String?
  createdAt       DateTime @default(now())
  customerId      String
  referenceNumber String?
  userId          String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  sale            Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([customerId])
  @@index([userId])
}

model AdvancePayment {
  id          String      @id @default(cuid())
  customerId  String
  userId      String
  amount      Float
  description String?
  reference   String?
  notes       String?
  createdAt   DateTime    @default(now())
  date        DateTime?   @default(now())  // ✅ ADDED: Date field for custom payment dates
  saleId      String?
  type        AdvanceType
  customer    Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  sale        Sale?       @relation(fields: [saleId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([userId])
  @@index([createdAt])
  @@index([saleId])
  @@index([date])  // ✅ ADDED: Index for better query performance
}

model Expense {
  id              String   @id
  location        String
  expenseCategory String
  expenseType     String
  amount          Float
  date            DateTime
  quantity        Float?
  ratePerUnit     Float?
  vendorName      String?
  notes           String?
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([expenseCategory])
  @@index([location])
  @@index([userId])
}

enum AdvanceType {
  ADVANCE_ADDED
  ADVANCE_PAYMENT
  ADVANCE_USED
}